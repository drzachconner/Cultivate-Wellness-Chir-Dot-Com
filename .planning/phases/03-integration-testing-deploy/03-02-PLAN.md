---
phase: 03-integration-testing-deploy
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: []
autonomous: false
requirements:
  - BACK-01
  - BACK-02
  - BACK-03
  - BACK-04
  - AUTH-01
  - AUTH-02
  - AUTH-03
  - CHAT-01
  - CONFIG-01
  - CONFIG-02
  - CONFIG-03
must_haves:
  truths:
    - "Port 3100 is running the real agent-backend (not Social-Media-Scaling)"
    - "Agent-backend accepts requests from cultivatewellnesschiro.com origin"
    - "Admin panel loads at localhost:5173, authenticates, and shows chat interface"
    - "A real chat message sent through admin panel receives a streamed response from Claude"
    - "A full round-trip edit-verify-revert cycle proves the entire pipeline works"
  artifacts:
    - path: "scripts/test-local-admin.sh"
      provides: "Local admin API integration test script"
  key_links:
    - from: "AdminOverlay (localhost:5173)"
      to: "agent-backend (localhost:3100)"
      via: "fetch with Bearer auth to /api/v1/projects/cultivate-wellness/*"
      pattern: "cultivate-agent\\.drzach\\.ai"
    - from: "agent-backend"
      to: "Claude API"
      via: "Claude Agent SDK chat endpoint"
      pattern: "/api/v1/projects/cultivate-wellness/chat"
---

<objective>
Fix the port conflict, verify agent-backend connectivity, and run a full round-trip integration test locally.

Purpose: Prove the complete admin pipeline works (frontend -> agent-backend -> Claude -> file tools -> git) before deploying to production.

Output: Verified local admin functionality with passing API tests and completed round-trip edit-verify-revert cycle.
</objective>

<execution_context>
@/Users/zachconnermba/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zachconnermba/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-integration-testing-deploy/03-RESEARCH.md
@.planning/phases/03-integration-testing-deploy/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix port 3100 conflict and verify agent-backend connectivity</name>
  <files></files>
  <action>
**Step 1: Diagnose port 3100 ownership**
```bash
lsof -i :3100
```
If the process is NOT agent-backend (look for `agent-backend/src/server.ts` in the command):
- Kill the wrong process: `kill <PID>`
- Wait 2 seconds for launchd to restart agent-backend, or restart manually: `cd ~/Code/agent-backend && npm start &`

**Step 2: Verify correct server on port 3100**
```bash
# Health check — agent-backend returns uptime + db status
curl -s http://localhost:3100/health | python3 -m json.tool

# Verify cultivate-wellness project is registered
curl -s http://localhost:3100/api/v1/projects/cultivate-wellness/info | python3 -m json.tool
```
Expected: health returns `{"status":"ok","uptime":...}` and project info returns the cultivate-wellness config.

**Step 3: Verify CORS accepts production origin**
```bash
curl -s -o /dev/null -w "%{http_code}" \
  -H "Origin: https://cultivatewellnesschiro.com" \
  http://localhost:3100/health
```
Expected: 200 (not 500 CORS rejection).

**Step 4: Verify authenticated endpoint**
```bash
# Get password from vault
PASS=$(vault-get CULTIVATE_ADMIN_PASSWORD 2>/dev/null || echo "")
# If vault-get unavailable, read from agent-backend .env
if [ -z "$PASS" ]; then
  PASS=$(grep CULTIVATE_ADMIN_PASSWORD ~/Code/agent-backend/.env | cut -d= -f2)
fi

curl -s -o /dev/null -w "%{http_code}" \
  -H "Authorization: Bearer $PASS" \
  http://localhost:3100/api/v1/projects/cultivate-wellness/usage
```
Expected: 200.

**Step 5: Verify Cloudflare tunnel routes correctly**
```bash
curl -s -o /dev/null -w "%{http_code}" https://cultivate-agent.drzach.ai/health
```
Expected: 200. If not, restart cloudflared:
```bash
launchctl kickstart -k gui/$(id -u)/com.cloudflare.cloudflared 2>/dev/null || cloudflared tunnel run &
```

If the port conflict does not exist (agent-backend is already on port 3100), skip the kill step and proceed to verification.
  </action>
  <verify>
All of these must return 200:
1. `curl -s -o /dev/null -w "%{http_code}" http://localhost:3100/health`
2. `curl -s -o /dev/null -w "%{http_code}" http://localhost:3100/api/v1/projects/cultivate-wellness/info`
3. `curl -s -o /dev/null -w "%{http_code}" -H "Origin: https://cultivatewellnesschiro.com" http://localhost:3100/health`
4. `curl -s -o /dev/null -w "%{http_code}" https://cultivate-agent.drzach.ai/health`
  </verify>
  <done>
Port 3100 belongs to agent-backend. Health, project info, CORS, and tunnel endpoints all return 200. The admin frontend can connect.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run local admin API integration tests</name>
  <files>scripts/test-local-admin.sh</files>
  <action>
Create a bash test script at `scripts/test-local-admin.sh` that validates all admin API endpoints work correctly through the agent-backend. This script runs against localhost:3100 (not through the tunnel).

The script should test:

1. **Health** — `GET /health` returns 200
2. **Project info** — `GET /api/v1/projects/cultivate-wellness/info` returns 200 + correct project name
3. **Auth rejection** — `GET /api/v1/projects/cultivate-wellness/usage` without Bearer token returns 401
4. **Auth acceptance** — `GET /api/v1/projects/cultivate-wellness/usage` with correct Bearer token returns 200
5. **CORS origin acceptance** — Request with `Origin: https://cultivatewellnesschiro.com` returns 200
6. **CORS origin rejection** — Request with `Origin: https://evil.com` returns 500 (agent-backend's CORS pattern)
7. **Conversations list** — `GET /api/v1/projects/cultivate-wellness/conversations` with auth returns 200 (may be empty array)
8. **Chat SSE streaming** — `POST /api/v1/projects/cultivate-wellness/chat` with auth and body `{"message":"What is the project name?","conversationId":"test-smoke"}` returns streamed SSE data (response contains lines starting with `data:`)

Script structure:
```bash
#!/bin/bash
set -euo pipefail
BASE="http://localhost:3100"
PASS="${CULTIVATE_ADMIN_PASSWORD:-}"
# Read from agent-backend .env if not in env
if [ -z "$PASS" ]; then
  PASS=$(grep CULTIVATE_ADMIN_PASSWORD ~/Code/agent-backend/.env 2>/dev/null | cut -d= -f2 || echo "")
fi
if [ -z "$PASS" ]; then
  echo "ERROR: CULTIVATE_ADMIN_PASSWORD not found"; exit 1
fi

FAIL=0
check() { ... }  # reusable check function from RESEARCH.md smoke test pattern

# Run all checks...
# Report results
```

Make the script executable: `chmod +x scripts/test-local-admin.sh`
Run it and verify all checks pass.
  </action>
  <verify>
1. `bash scripts/test-local-admin.sh` outputs "ALL CHECKS PASSED"
2. No FAIL lines in output
3. Chat SSE test within the script confirms streamed `data:` lines returned
  </verify>
  <done>
All local API integration tests pass: health, project info, auth, CORS, conversations, and chat SSE streaming endpoints verified.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Localhost round-trip integration test (edit-commit-revert via admin chat in browser)</name>
  <files>N/A (human verification only)</files>
  <action>
**What was built:**
Tasks 1-2 verified that agent-backend is running on port 3100, all API endpoints respond correctly, and chat SSE streaming works via automated curl tests. The admin frontend is served by `npm run dev` at localhost:5173. This checkpoint verifies the full round-trip pipeline in a real browser — the critical proof that the entire system works end-to-end (frontend -> agent-backend -> Claude -> file tools -> git -> verify -> revert).

**How to verify:**

**Pre-requisite:** `npm run dev` is running at `http://localhost:5173`.

**Step 1: Open admin panel**
Navigate to `http://localhost:5173/admin` in a browser. Verify:
- AdminActivator catches the path and opens a floating overlay panel
- URL changes back to `/` (history replaced)
- PasswordGate is displayed (no Remember Me checkbox visible)

**Step 2: Authenticate**
Enter the admin password. Verify:
- Password validates against agent-backend (fetchUsage succeeds)
- Chat interface appears with welcome message from constants.ts
- Quick action buttons are visible

**Step 3: Send a test message**
Type "What files make up the homepage?" and send. Verify:
- Message streams in real-time
- Tool status indicators appear (if Claude uses tools)
- Response completes with meaningful content about the homepage files

**Step 4: Full round-trip test (per CONTEXT.md requirement)**
Send: "Please add a comment `// integration-test-marker-2026-02-20` to the very top of src/data/site.ts, then commit with message 'test: integration test marker'"

Verify in the browser:
- Claude reads site.ts, adds the comment, commits
- The change log panel shows the new commit
- Deploy countdown timer appears (since a commit was made)

Then verify from terminal:
```bash
head -1 src/data/site.ts  # Should show the marker comment
git log --oneline -1      # Should show "test: integration test marker"
```

**Step 5: Revert the test**
Send in admin chat: "Please revert the last commit with `git revert HEAD --no-edit`"

Verify from terminal:
```bash
head -1 src/data/site.ts  # Marker comment should be gone
git log --oneline -2      # Should show revert commit + original test commit
```

**Step 6: Verify other UI features**
- Minimize the panel (click minimize button) — panel should collapse to a taskbar item
- Restore the panel — should return to previous size and position
- Resize the panel (compact/medium/large toggle) — panel dimensions change
- Close the panel — overlay disappears
- Verify public chatbot reappears when admin panel is closed

**If the round-trip test fails (Claude can't edit files):**
- Check agent-backend logs: `tail -50 ~/Code/agent-backend/logs/server.log`
- Verify REPO_PATH in projects.json points to `/Users/zachconnermba/Code/Cultivate-Wellness-Chir-Dot-Com`
- Verify the agent-backend process has write permissions to the repo directory

**Resume signal:** Type "approved" if the full round-trip (edit-commit-revert) worked and UI features are functional, or describe any issues found.
  </action>
  <verify>
Human confirms:
1. Admin panel opens at localhost:5173/admin with password gate (no Remember Me)
2. Chat messages stream in real-time with meaningful responses
3. Round-trip edit: `head -1 src/data/site.ts` shows `// integration-test-marker-2026-02-20` and `git log --oneline -1` shows "test: integration test marker"
4. Round-trip revert: `head -1 src/data/site.ts` shows original content (no marker) and `git log --oneline -2` shows both the test commit and the revert commit
5. UI features (minimize, restore, resize, close) all function correctly
  </verify>
  <done>
Full localhost round-trip verified by human: file edited via admin chat, commit visible in git log, revert successful, src/data/site.ts restored to original state. Admin panel UI features (minimize, resize, close) all functional. The complete pipeline (frontend -> agent-backend -> Claude -> file tools -> git) is proven working locally.
  </done>
</task>

</tasks>

<verification>
1. Port 3100 belongs to agent-backend: `lsof -i :3100 | grep agent-backend`
2. All API integration tests pass (including chat SSE): `bash scripts/test-local-admin.sh` outputs "ALL CHECKS PASSED"
3. Cloudflare tunnel is live: `curl -s -o /dev/null -w "%{http_code}" https://cultivate-agent.drzach.ai/health` returns 200
4. Human confirmed: localhost round-trip edit-commit-revert cycle completed successfully in browser
5. Human confirmed: `git log` shows test commit + revert commit, and `src/data/site.ts` is clean (marker removed)
</verification>

<success_criteria>
- Agent-backend is running on port 3100 and accepts requests from production origins
- All API endpoints (health, info, usage, conversations, chat) respond correctly
- Chat messages stream through the full pipeline (frontend -> agent-backend -> Claude)
- Round-trip test proves Claude can edit files, commit, and the changes are visible
- Cloudflare tunnel routes correctly to agent-backend
</success_criteria>

<output>
After completion, create `.planning/phases/03-integration-testing-deploy/03-02-SUMMARY.md`
</output>
