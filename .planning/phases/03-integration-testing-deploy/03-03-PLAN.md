---
phase: 03-integration-testing-deploy
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - scripts/smoke-test.sh
autonomous: false
requirements:
  - AUTH-01
  - AUTH-02
  - AUTH-03
  - AUTH-04
  - UI-01
  - UI-02
  - UI-03
  - UI-04
  - UI-05
  - CHAT-01
  - CHAT-02
  - CHAT-03
  - CHAT-04
  - CHAT-05
  - TRACK-01
  - TRACK-02
  - CONFIG-01
  - CONFIG-02
  - CONFIG-03
  - BACK-01
  - BACK-02
  - BACK-03
  - BACK-04
must_haves:
  truths:
    - "Production site at cultivatewellnesschiro.com serves all public pages with 200 status"
    - "Admin panel at cultivatewellnesschiro.com/admin opens the floating overlay"
    - "Admin authenticates against cultivate-agent.drzach.ai without CORS errors"
    - "Chat works on production — messages stream through the tunnel to agent-backend"
    - "No regression in public chatbot, contact form, service pages, condition pages"
    - "SEO elements intact: Schema.org JSON-LD present, meta tags correct, sitemap accessible"
    - "/admin excluded from robots.txt and does not appear in sitemap"
  artifacts:
    - path: "scripts/smoke-test.sh"
      provides: "Post-deploy production smoke test"
  key_links:
    - from: "cultivatewellnesschiro.com (Cloudflare Pages)"
      to: "cultivate-agent.drzach.ai (Cloudflare Tunnel)"
      via: "HTTPS cross-origin fetch with Bearer auth"
      pattern: "cultivate-agent\\.drzach\\.ai"
    - from: "GitHub Actions (deploy.yml)"
      to: "Cloudflare Pages"
      via: "wrangler pages deploy"
      pattern: "push to main triggers auto-deploy"
---

<objective>
Deploy to production, run automated smoke tests, verify no regressions, and get human sign-off on the admin panel.

Purpose: Ship the admin panel to production and confirm everything works end-to-end on the live domain with real CORS, real tunnel routing, and real Cloudflare Pages serving.

Output: Production-verified admin panel at cultivatewellnesschiro.com/admin with all public features intact.
</objective>

<execution_context>
@/Users/zachconnermba/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zachconnermba/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-integration-testing-deploy/03-RESEARCH.md
@.planning/phases/03-integration-testing-deploy/03-01-SUMMARY.md
@.planning/phases/03-integration-testing-deploy/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy to production and run automated smoke tests</name>
  <files>scripts/smoke-test.sh</files>
  <action>
**Step 1: Create the smoke test script**

Create `scripts/smoke-test.sh` based on the template from RESEARCH.md. The script tests:

1. **Public site routes** (all must return 200):
   - `/` (home)
   - `/about-us`
   - `/meet-dr-zach`
   - `/pediatric` (or `/pediatric-chiropractic`)
   - `/prenatal` (or `/prenatal-chiropractic`)
   - `/family` (or `/family-chiropractic`)
   - `/contact-us`
   - `/conditions`
   - `/insight-scans`
   - `/workshops`
   - `/new-patient-info`
   - `/rhkn-guide` (guide download page — contains GuideForm component)
   - `/free-guides-for-parents` (guide listing page)
   - `/sitemap.xml`
   - `/robots.txt`

2. **Admin route** (200 — SPA returns index.html):
   - `/admin`

3. **API endpoints** (Cloudflare Functions):
   - `POST /api/chat` with empty body → should return 400 (validation error, not 404/405)
   - `POST /api/form-handler` with empty body → should return 400

4. **Agent backend health** (through Cloudflare tunnel):
   - `GET https://cultivate-agent.drzach.ai/health` → 200
   - `GET https://cultivate-agent.drzach.ai/api/v1/projects/cultivate-wellness/usage` without auth → 401
   - `GET https://cultivate-agent.drzach.ai/api/v1/projects/cultivate-wellness/usage` with auth → 200

5. **SEO verification**:
   - `/robots.txt` contains `Disallow: /admin`
   - `/sitemap.xml` does NOT contain `/admin`
   - Home page HTML contains `application/ld+json` (Schema.org present)

6. **CORS verification** (critical — this is the cross-origin production test):
   - `curl -H "Origin: https://cultivatewellnesschiro.com" https://cultivate-agent.drzach.ai/health` returns 200 with `Access-Control-Allow-Origin` header

Make executable: `chmod +x scripts/smoke-test.sh`

**Step 2: Commit and push to deploy**

Stage the code fixes from Plan 01 (sessionStorage changes, robots.txt, Admin.tsx deletion) plus the test scripts:
```bash
git add -A
git commit -m "feat: admin panel sessionStorage-only auth, robots.txt /admin exclusion, smoke tests

- Remove localStorage from PasswordGate and AdminContext (sessionStorage only per security decision)
- Remove orphaned Admin.tsx page (floating overlay is the production architecture)
- Add Disallow: /admin to robots.txt
- Add local API test script and production smoke test script"
git push origin main
```

**Step 3: Wait for deploy and run smoke test**

Wait ~90 seconds for GitHub Actions to build and deploy to Cloudflare Pages. Check deploy status:
```bash
# Check GitHub Actions status
gh run list --limit 1
# Or wait and poll
sleep 90
```

Then run the smoke test:
```bash
bash scripts/smoke-test.sh
```

**If smoke test fails:**
- Check which endpoints failed
- For CORS failures: verify agent-backend is running and accepting production origins (may need Helmet `crossOriginResourcePolicy` fix — see Pitfall 4 in RESEARCH.md)
- For API failures: check Cloudflare Pages function logs
- For 404s: check that the SPA fallback (`public/_redirects`) is working
- Fix the issue and re-push. Per CONTEXT.md: "If deploy pipeline fails: fix the issue and retry"
  </action>
  <verify>
1. `gh run list --limit 1` shows the latest run completed successfully
2. `bash scripts/smoke-test.sh` outputs "ALL CHECKS PASSED"
3. `curl -s https://cultivatewellnesschiro.com/robots.txt | grep "Disallow: /admin"` returns the line
  </verify>
  <done>
Code deployed to production via GitHub Actions. All smoke test checks pass: public routes return 200, API endpoints respond, agent backend is accessible through tunnel, CORS works from production domain, SEO elements intact, /admin excluded from robots.txt.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of production admin panel</name>
  <files>N/A (human verification only)</files>
  <action>
**What was built:**
Complete admin panel deployed to production at cultivatewellnesschiro.com/admin, including:
- Floating overlay admin panel with password gate (sessionStorage-only)
- Streaming chat with Claude agent backend through Cloudflare tunnel
- Conversation history, quick actions, change log
- Draggable/resizable/minimizable panels
- Mobile fullscreen support
- Public chatbot auto-hiding when admin active
- All public site features intact (no regression)

**How to verify — Admin Panel:**
1. Open https://cultivatewellnesschiro.com/admin in a browser
2. Verify the floating overlay appears with a password prompt (NO "Remember me" checkbox)
3. Enter the admin password — chat interface should load with welcome message
4. Send a test message (e.g., "What pages does this site have?") — verify streamed response
5. Check quick action buttons are visible and relevant to Cultivate Wellness
6. Minimize the panel — verify it collapses to taskbar
7. Restore and resize (compact/medium/large) — verify dimensions change
8. Close the panel — verify public chatbot reappears in bottom-right corner
9. Close the browser tab, reopen https://cultivatewellnesschiro.com/admin — verify you must re-enter password (sessionStorage cleared)

**How to verify — Mobile (optional):**
10. Open on a phone or use Chrome DevTools mobile view — verify fullscreen admin panel

**How to verify — Change Log & Deploy Countdown (TRACK-01, TRACK-02):**
11. In the admin chat, send any edit command (e.g., "Add a comment `// track-test` to src/data/site.ts and commit") — after Claude commits, verify the **change log panel** populates with the new commit entry (TRACK-01)
12. After the commit, verify the **deploy countdown timer** appears in the admin panel (should count down from ~90 seconds, per DEPLOY_COUNTDOWN_SECONDS) (TRACK-02)
13. Revert the test commit via admin chat: "Revert the last commit with `git revert HEAD --no-edit`"

**How to verify — Regression:**
14. Navigate to the home page — verify hero, services, testimonials render
15. Click through to a service page (e.g., Pediatric) — verify content loads
16. Click through to a condition page (e.g., /conditions/adhd-focus-issues) — verify content
17. Open the public chatbot (bottom-right widget) — send a test message
18. Navigate to Contact Us — verify form renders (no need to submit)
19. Navigate to `/rhkn-guide` — verify the guide download page loads and the GuideForm component renders (name/email form visible)
20. Navigate to `/free-guides-for-parents` — verify the guide listing page loads with guide cards/links
21. Check browser console for errors — should be clean (no 500s, no CORS errors)

**Resume signal:** Type "approved" if everything works, or describe any issues found.
  </action>
  <verify>Human confirms all verification steps pass with no issues.</verify>
  <done>Admin panel works end-to-end on production. No regressions in public site. User approved.</done>
</task>

</tasks>

<verification>
1. GitHub Actions deploy succeeded
2. All smoke test checks pass
3. Admin panel works on production domain
4. No CORS errors in browser console
5. Public site features intact (no regression)
6. SEO elements present (Schema.org, meta tags, sitemap)
7. /admin excluded from robots.txt
</verification>

<success_criteria>
- Production deploy complete and verified via automated smoke test
- Human confirms admin panel works end-to-end on cultivatewellnesschiro.com
- No regression in any public-facing feature
- sessionStorage-only auth verified (re-login required on tab close)
- CORS working between production frontend and agent-backend tunnel
</success_criteria>

<output>
After completion, create `.planning/phases/03-integration-testing-deploy/03-03-SUMMARY.md`
</output>
